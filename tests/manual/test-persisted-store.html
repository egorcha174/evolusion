<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Persisted Store Fix</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .test-section {
            margin-bottom: 20px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        button {
            padding: 8px 16px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        button:hover {
            background-color: #45a049;
        }
        .results {
            margin-top: 10px;
            padding: 10px;
            background-color: #f5f5f5;
            border-radius: 4px;
        }
        .error {
            color: red;
        }
        .success {
            color: green;
        }
    </style>
</head>
<body>
    <h1>Тест сохранения данных подключения</h1>

    <div class="test-section">
        <h2>Тест 1: Проверка миграции данных</h2>
        <button onclick="testMigration()">Запустить тест миграции</button>
        <div id="migration-results" class="results"></div>
    </div>

    <div class="test-section">
        <h2>Тест 2: Проверка сохранения данных</h2>
        <button onclick="testPersistence()">Запустить тест сохранения</button>
        <div id="persistence-results" class="results"></div>
    </div>

    <div class="test-section">
        <h2>Тест 3: Проверка восстановления после обновления</h2>
        <button onclick="testRefreshRecovery()">Запустить тест восстановления</button>
        <div id="refresh-results" class="results"></div>
    </div>

    <div class="test-section">
        <h2>Ручная проверка</h2>
        <button onclick="clearAllData()">Очистить все данные</button>
        <button onclick="showCurrentStorage()">Показать текущее состояние хранилища</button>
        <div id="manual-results" class="results"></div>
    </div>

    <script>
        // Симуляция функций из servers.ts
        function testMigration() {
            const resultsDiv = document.getElementById('migration-results');
            resultsDiv.innerHTML = 'Тестирование миграции...';

            try {
                // Симулируем legacy данные
                const legacyData = {
                    servers: [
                        { id: 'test-server-1', name: 'Test Server', url: 'http://test.local', token: 'test-token-123', enabled: true }
                    ],
                    activeServerId: 'test-server-1'
                };

                // Сохраняем в legacy storage
                localStorage.setItem('ha_servers_v2', JSON.stringify(legacyData.servers));
                localStorage.setItem('active_server_id', legacyData.activeServerId);

                // Проверяем, что persisted storage пустой
                const persistedServers = localStorage.getItem('ha_servers_enc');
                const persistedActiveServer = localStorage.getItem('ha_connection_enc');

                if (!persistedServers && !persistedActiveServer) {
                    resultsDiv.innerHTML += '<div class="success">✓ Legacy данные сохранены, persisted storage пустой</div>';

                    // Симулируем загрузку приложения (миграция должна произойти)
                    // В реальном приложении это происходит в initialization коде
                    resultsDiv.innerHTML += '<div class="success">✓ Миграция должна произойти при загрузке приложения</div>';
                } else {
                    resultsDiv.innerHTML += '<div class="error">✗ Persisted storage не пустой, тест не валиден</div>';
                }
            } catch (error) {
                resultsDiv.innerHTML += `<div class="error">✗ Ошибка: ${error.message}</div>`;
            }
        }

        function testPersistence() {
            const resultsDiv = document.getElementById('persistence-results');
            resultsDiv.innerHTML = 'Тестирование сохранения данных...';

            try {
                // Очищаем все данные
                localStorage.clear();

                // Симулируем добавление сервера
                const testServer = { id: 'persist-test-1', name: 'Persist Test', url: 'http://persist.test', token: 'persist-token', enabled: true };

                // В реальном приложении это делается через persisted stores
                // Здесь мы просто проверяем, что данные сохраняются
                localStorage.setItem('ha_servers_enc', JSON.stringify([testServer]));
                localStorage.setItem('ha_connection_enc', JSON.stringify('persist-test-1'));

                // Проверяем, что данные сохранены
                const savedServers = localStorage.getItem('ha_servers_enc');
                const savedActiveServer = localStorage.getItem('ha_connection_enc');

                if (savedServers && savedActiveServer) {
                    resultsDiv.innerHTML += '<div class="success">✓ Данные успешно сохранены в persisted storage</div>';
                } else {
                    resultsDiv.innerHTML += '<div class="error">✗ Данные не сохранены</div>';
                }
            } catch (error) {
                resultsDiv.innerHTML += `<div class="error">✗ Ошибка: ${error.message}</div>`;
            }
        }

        function testRefreshRecovery() {
            const resultsDiv = document.getElementById('refresh-results');
            resultsDiv.innerHTML = 'Тестирование восстановления после обновления...';

            try {
                // Симулируем данные, которые должны быть сохранены
                const testData = {
                    servers: [
                        { id: 'refresh-test-1', name: 'Refresh Test Server', url: 'http://refresh.test', token: 'refresh-token', enabled: true }
                    ],
                    activeServerId: 'refresh-test-1'
                };

                // Сохраняем в persisted storage (как это делает приложение)
                localStorage.setItem('ha_servers_enc', JSON.stringify(testData.servers));
                localStorage.setItem('ha_connection_enc', JSON.stringify(testData.activeServerId));

                // Симулируем обновление страницы - данные должны остаться
                // В реальном приложении это происходит автоматически через persisted stores
                const recoveredServers = localStorage.getItem('ha_servers_enc');
                const recoveredActiveServer = localStorage.getItem('ha_connection_enc');

                if (recoveredServers && recoveredActiveServer) {
                    const parsedServers = JSON.parse(recoveredServers);
                    const parsedActiveServer = JSON.parse(recoveredActiveServer);

                    if (parsedServers.length === testData.servers.length &&
                        parsedActiveServer === testData.activeServerId) {
                        resultsDiv.innerHTML += '<div class="success">✓ Данные успешно восстановлены после "обновления"</div>';
                    } else {
                        resultsDiv.innerHTML += '<div class="error">✗ Восстановленные данные не совпадают с оригинальными</div>';
                    }
                } else {
                    resultsDiv.innerHTML += '<div class="error">✗ Данные не восстановлены</div>';
                }
            } catch (error) {
                resultsDiv.innerHTML += `<div class="error">✗ Ошибка: ${error.message}</div>`;
            }
        }

        function clearAllData() {
            const resultsDiv = document.getElementById('manual-results');
            localStorage.clear();
            resultsDiv.innerHTML = '<div class="success">✓ Все данные очищены</div>';
        }

        function showCurrentStorage() {
            const resultsDiv = document.getElementById('manual-results');
            resultsDiv.innerHTML = '<h3>Текущее состояние хранилища:</h3>';

            const storageKeys = [
                'ha_servers_v2',
                'active_server_id',
                'ha_servers_enc',
                'ha_connection_enc'
            ];

            storageKeys.forEach(key => {
                const value = localStorage.getItem(key);
                const displayValue = value ? value.substring(0, 50) + (value.length > 50 ? '...' : '') : 'null';
                resultsDiv.innerHTML += `<div><strong>${key}:</strong> ${displayValue}</div>`;
            });
        }
    </script>
</body>
</html>
