# Улучшение шифрования параметров подключения к серверам Home Assistant

## Обзор изменений

Этот документ описывает улучшения в системе шифрования параметров подключения к серверам Home Assistant в проекте Evolusion.

## Что было изменено

### 1. Новые функции шифрования

Добавлены новые функции в `src/lib/utils/crypto.ts`:

- `encryptServerConfig(data: any): string` - шифрует всю конфигурацию сервера
- `decryptServerConfig(encryptedData: string): any` - расшифровывает конфигурацию сервера

### 2. Обновленная логика хранения

Обновлены функции в `src/lib/stores/servers.ts`:

- `saveServersToStorage()` - теперь сохраняет полностью зашифрованные конфигурации серверов
- `loadServersFromStorage()` - поддерживает загрузку как новых (полностью зашифрованных), так и старых (частично зашифрованных) форматов

### 3. Обратная совместимость

Решение поддерживает обратную совместимость со старыми данными:
- Старые данные с зашифрованными только токенами будут корректно загружены
- Новые данные используют полное шифрование всей конфигурации

## Преимущества нового подхода

1. **Полное шифрование**: Теперь шифруются все параметры подключения (URL, имя, токен, статус), а не только токен
2. **Обратная совместимость**: Система автоматически определяет формат данных и корректно обрабатывает оба варианта
3. **Безопасность**: Улучшена защита конфиденциальных данных в localStorage
4. **Надежность**: Улучшена обработка ошибок и поврежденных данных

## Тестирование

Добавлены комплексные тесты:
- `src/lib/utils/crypto.test.ts` - тесты функций шифрования
- `src/lib/stores/servers.test.ts` - интеграционные тесты хранилища

Все тесты проходят успешно, подтверждая работоспособность решения.

## Использование

Новые функции автоматически используются существующим кодом. Нет необходимости вносить изменения в интерфейсные компоненты или другие части приложения.

### Пример использования

```typescript
import { saveServersToStorage, loadServersFromStorage } from '$lib/stores/servers';

// Сохранение серверов (автоматически шифрует все данные)
const servers = [
  {
    id: 'server-1',
    name: 'Мой Home Assistant',
    url: 'https://homeassistant.local:8123',
    token: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...',
    enabled: true
  }
];

saveServersToStorage(servers);

// Загрузка серверов (автоматически расшифровывает данные)
const loadedServers = loadServersFromStorage();
```

## Миграция данных

При первом запуске с новым кодом:
1. Старые данные будут автоматически загружены и преобразованы
2. При сохранении данные будут сохранены в новом формате
3. Пользователь не заметит изменений в интерфейсе

## Безопасность

Хотя новое решение улучшает защиту данных, важно помнить:
- Используется XOR шифр с base64 - это не криптографически стойкое решение
- Основная цель - защита от случайного просмотра данных в localStorage
- Для полной безопасности рекомендуется использовать HTTPS и другие меры защиты на уровне сервера

## Заключение

Улучшенная система шифрования предоставляет более надежную защиту параметров подключения к серверам Home Assistant, сохраняя при этом полную обратную совместимость и удобство использования.
